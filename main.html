<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>KERNLET</title>
<!-- Подключение CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css" />
<style>
body {
  margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: flex; flex-direction: column; height: 100vh;
  transition: background 0.5s, color 0.5s;
  background: linear-gradient(135deg, #2c3e50, #4ca1af);
}
body.light { background: #ecf0f1; color: #222; }
body.dark { background: #222; color: #eee; }
body.golden { background: #FFD700; color: #000; }

header {
  padding: 10px 20px; display: flex; align-items:center; justify-content: space-between; flex-wrap: wrap;
  background: rgba(0,0,0,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
h1 {
  margin: 0; font-size: 1.8em; letter-spacing: 2px; animation: pulse 2s infinite;
}
@keyframes pulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.7; }
}
button {
  border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;
  font-weight: bold; transition: all 0.3s;
  background: #34495e; color: #fff;
}
button:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
button.active { background: #27ae60; }

#main {
  flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 10px; overflow: hidden;
}
#tabs {
  display: flex; gap: 10px; margin-bottom: 10px;
}
.tab {
  padding: 8px 16px; background: #34495e; border-radius: 5px; cursor: pointer;
  font-weight: bold; transition: background 0.3s;
}
.tab.active { background: #2980b9; }

#content {
  display: flex; flex-direction: column; flex: 1; gap:10px;
}
#editorContainer {
  display: flex; flex-direction: column; flex: 2; background: rgba(255,255,255,0.05);
  border-radius: 10px; padding: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
  height: 300px;
}
#editor { flex: 1; height: 100%; }
#terminal {
  flex: 1; background: #000; padding: 10px; margin-top: 10px; border-radius: 8px;
  overflow-y: auto; font-family: monospace; font-size: 0.9em; color: #0f0; white-space: pre-wrap;
  min-height: 100px;
}
</style>
</head>
<body>
<header>
  <div style="display:flex; align-items:center;">
    <h1>KERNLET - расширенное</h1>
    <div id="modeButtons" style="margin-left:20px;">
      <button id="btn-code" class="mode active">Код</button>
      <button id="btn-os" class="mode">OS</button>
      <button id="btn-bios" class="mode bios">Биос</button>
    </div>
    <button id="btn-run">Запуск</button>
    <button id="btn-clear-all">Очистить</button>
    <button id="btn-theme">Сменить тему</button>
  </div>
</header>

<!-- Вкладки -->
<div id="tabs">
  <div class="tab active" data-tab="code">Код</div>
  <div class="tab" data-tab="settings">Настройки</div>
</div>

<div id="content">
  <!-- Таб "Код" -->
  <div id="tab-code" class="tab-content" style="display:flex; flex-direction:column; flex:1;">
    <div id="editorContainer" style="flex:1; display:flex; flex-direction:column;">
      <div id="editor"></div>
      <div style="margin-top:5px; display:flex; gap:10px;">
        <button id="btnLoadFile">Загрузить файл</button>
        <button id="btnSaveFile">Сохранить как</button>
        <input type="file" id="fileInput" style="display:none;" />
      </div>
      <div>Терминал:</div>
      <div id="terminal" class="code"></div>
    </div>
  </div>
  <!-- Таб "Настройки" -->
  <div id="tab-settings" class="tab-content" style="display:none;">
    <div id="settings">
      <h3>Обои</h3>
      <button id="btnChangeWallpaper">Выбрать обои</button>
      <input type="file" id="uploadWallpaper" accept="image/*" style="display:none;">
      <h3>Музыка</h3>
      <input type="file" id="uploadMusic" accept="audio/*" />
      <audio id="music" controls></audio>
      <h3>Темы</h3>
      <button id="btnGolden">Золотистая</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
<script>
// Инициализация редактора
const cm = CodeMirror(document.getElementById('editor'), {
  mode: 'text/x-csrc',
  theme: 'monokai',
  lineNumbers: true,
  value: `// Введите код\nfn main() {\n println!(\"Hello\") }\n`
});
const terminal = document.getElementById('terminal');
const fileInput = document.getElementById('fileInput');

// Обработчик для кнопки "Очистить"
document.getElementById('btn-clear-all').onclick= ()=> {
  cm.setValue('');
  document.getElementById('terminal').innerHTML='>_ ';
};

// Остальной код — без изменений
const systemCommands = [
  "ls", "cd", "pwd", "mkdir", "rm", "cp", "mv", "touch", "cat", "less", "head", "tail", "grep", "find", "chmod", "chown", "chgrp", "tar", "zip", "unzip",
  "adduser", "usermod", "deluser", "passwd", "su", "sudo", "finger", "who", "id", "groups", "useradd", "userdel", "last", "w", "logout",
  "apt-get", "dpkg", "snap", "systemctl", "service", "ifconfig", "ip", "netstat", "ping", "traceroute", "ssh", "scp", "rsync", "crontab", "at", "nohup", "history",
  "top", "ps", "kill", "pkill", "htop", "free", "vmstat", "killall", "renice", "nice", "pgrep", "strace", "lsof", "sar", "uptime", "time",
  "shutdown", "reboot", "halt", "poweroff", "systemctl", "service", "ifconfig", "ip", "netstat", "ping", "traceroute", "ssh", "scp", "rsync",
  "smem", "sync", "swapoff", "swapon", "sysctl", "ulimit", "pmap", "slabtop", "numactl", "sysrq", "mdb"
];

const modeBtn = {
  code: document.getElementById('btn-code'),
  os: document.getElementById('btn-os'),
  bios: document.getElementById('btn-bios')
};

let currentMode='code';

function setMode(mode) {
  for (let key in modeBtn) modeBtn[key].classList.remove('active');
  modeBtn[mode].classList.add('active');
  document.body.className='';
  if (mode==='os') {
    document.body.classList.add('green');
    terminal.className='os';
  } else if (mode==='bios') {
    document.body.classList.add('red');
    terminal.className='bios';
  } else {
    document.body.className='light';
    terminal.className='code';
  }
  currentMode=mode;
}
document.getElementById('btn-code').onclick= ()=> { setMode('code'); }
document.getElementById('btn-os').onclick= ()=> { setMode('os'); }
document.getElementById('btn-bios').onclick= ()=> { setMode('bios'); }
setMode('code');

document.getElementById('btn-theme').onclick= ()=> {
  document.body.className= (document.body.className==='light') ? 'dark' : 'light';
}

document.getElementById('btnGolden').onclick= ()=> {
  document.body.className='golden';
}

document.getElementById('btnLoadFile').onclick= ()=> {
  fileInput.click();
};
fileInput.onchange= ()=> {
  const file=fileInput.files[0];
  const reader=new FileReader();
  reader.onload= ()=> {
    cm.setValue(reader.result);
  };
  reader.readAsText(file);
};

document.getElementById('btnSaveFile').onclick= ()=> {
  const content=cm.getValue();
  const blob=new Blob([content], {type:'text/plain'});
  const url= URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='code.txt'; a.click();
  URL.revokeObjectURL(url);
};

// Вкладки
const tabs = document.querySelectorAll('#tabs .tab');
tabs.forEach(t => {
  t.onclick= ()=> {
    document.querySelectorAll('#tabs .tab').forEach(t2=>t2.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-'+t.dataset.tab).style.display='flex';
  }
});

// Для вывода и ввода команд
function appendToTerminal(text) {
  if (!terminal.innerText.endsWith('\n') && terminal.innerText.length>0) {
    terminal.innerHTML += '\n' + text;
  } else {
    terminal.innerHTML += text;
  }
  terminal.scrollTop=terminal.scrollHeight;
}

let isTerminalInputActive=false;
function enableTerminalInput() {
  terminal.contentEditable=true;
  terminal.addEventListener('keydown', handleTerminalKey);
}
function disableTerminalInput() {
  terminal.contentEditable=false;
  terminal.removeEventListener('keydown', handleTerminalKey);
}
function handleTerminalKey(e) {
  if (e.key==='Enter') {
    e.preventDefault();
    // Получить последнюю строку
    const sel=window.getSelection();
    const node=sel.anchorNode;
    const parent=node.parentNode;
    const lines=parent.innerText.split('\n');
    const lastLine=lines[lines.length-1].trim();

    if (lastLine==='exit' || lastLine==='end') {
      disableTerminalInput();
      return;
    }

    // Обработка команд
    let response='';
    if (currentMode==='os' || currentMode==='bios') {
      if (systemCommands.includes(lastLine)) {
        switch(lastLine) {
          case 'ls': response='file1.txt  file2.txt  folder/'; break;
          case 'pwd': response='/home/user'; break;
          case 'who': response='user1  user2'; break;
          case 'id': response='uid=1000(user) gid=1000(user)'; break;
          case 'ps': response='PID TTY TIME CMD\n1234 pts/0 00:00 bash\n'; break;
          case 'uptime': response=' 10:23:45 up 2 days,  4:12,  3 users,  load average: 0.00, 0.01, 0.05'; break;
          case 'date': response='Tue Apr 27 10:23:45 MSK 2024'; break;
          case 'end': response='Завершение работы...'; break;
          default: response='Выполняется команда: '+lastLine; break;
        }
      } else {
        response='Команда не распознана.';
      }
    } else {
      response='В режиме "Код" ввод команд недопустим.';
    }
    appendToTerminal('\n'+response+'\n');
  }
}

// Изначально для "Код"
setMode('code');

// При запуске в "OS" или "Биос" активируем режим ввода команд
function startSystem(mode) {
  enableTerminalInput();
  if (mode==='bios') {
    appendToTerminal('Запущен BIOS.\n');
  } else if (mode==='os') {
    appendToTerminal('Запущена ОС.\n');
  }
  // Выводим список команд
  appendToTerminal('Доступные команды:\n' + systemCommands.join(', ') + '\n');
}

// Обработчик "Запуск"
document.getElementById('btn-run').onclick= ()=> {
  if (currentMode==='code') {
    if (!cm.getValue().includes('///AllowEdit')) {
      document.getElementById('terminal').innerText='Запуск в кодовом режиме запрещен без ///AllowEdit.';
      return;
    }
    const regex=/\"([^\"]*)\"/g;
    let match, out='';
    while ((match=regex.exec(cm.getValue()))!==null) {
      out+=match[1]+'\n';
    }
    document.getElementById('terminal').innerText=out;
  } else if (currentMode==='os' || currentMode==='bios') {
    document.getElementById('terminal').innerText='';
    startSystem(currentMode);
  }
};

// Обработка выбора обоев
const btnChangeWallpaper = document.getElementById('btnChangeWallpaper');
const uploadWallpaper = document.getElementById('uploadWallpaper');

btnChangeWallpaper.onclick= ()=> {
  uploadWallpaper.click();
};

uploadWallpaper.onchange= ()=> {
  const file=uploadWallpaper.files[0];
  if (!file) return;
  const reader=new FileReader();
  reader.onload= ()=> {
    document.body.style.backgroundImage=`url(${reader.result})`;
  };
  reader.readAsDataURL(file);
};

// Музыка
const uploadMusic = document.getElementById('uploadMusic');
const musicEl = document.getElementById('music');
uploadMusic.onchange= ()=> {
  const file=uploadMusic.files[0];
  if (!file) return;
  const url= URL.createObjectURL(file);
  musicEl.src=url;
  musicEl.play();
};
</script>
</body>
</html>
